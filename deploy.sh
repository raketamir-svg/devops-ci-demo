#!/bin/bash

# --- 1. Подготовка и сборка (CI - Continuous Integration) ---
echo "--- 1. Сборка нового образа App3..."
# Собираем только измененный сервис App3, принудительно, чтобы использовать свежий код
docker compose build app3

# Проверяем успешность сборки
if [ $? -ne 0 ]; then
    echo "ОШИБКА: Сборка образа App3 завершилась неудачно."
    exit 1
fi

# --- 2. Развертывание (CD - Continuous Deployment) ---
echo "--- 2. Развертывание (Обновление сервиса с сохранением MySQL)..."

# Запуск только сервиса app3. Флаг --no-deps гарантирует,
# что существующий mysql-контейнер не будет перезапускаться.
# Флаг --force-recreate заставляет Docker Compose удалить старый app3-контейнер и запустить новый.
docker compose up -d app3 --no-deps --force-recreate

# Проверяем успешность развертывания
if [ $? -ne 0 ]; then
    echo "ОШИБКА: Развертывание App3 завершилось неудачно."
    exit 1
fi

echo "--- 3. Обновление Nginx Load Balancer..."

# Перезапускаем только прокси, чтобы Nginx гарантированно увидел новый app3-контейнер
# (На самом деле Nginx видит его автоматически, но это хорошая практика для гарантии)
docker compose up -d proxy --no-deps --force-recreate

echo "--- 4. Автоматическое развертывание успешно завершено!"
echo "Проверьте работу системы по адресу: http://192.168.56.4:8085"
